---
export const prerender = false;

import { supabase } from "../../lib/supabaseClient";

let success = false;
let error = "";

if (Astro.request.method === "POST") {
	try {
		console.log("üìù Procesando formulario de creaci√≥n de producto...");

		const formData = await Astro.request.formData();

		const title = formData.get("title")?.toString() || "";
		const description = formData.get("description")?.toString() || "";
		const price = parseFloat(formData.get("price")?.toString() || "0");
		const stock = parseInt(formData.get("stock")?.toString() || "0");
		const category = formData.get("category")?.toString() || "";
		
		// Campos opcionales (solo si existen en DB)
		const sku = formData.get("sku")?.toString() || "";
		const weight = parseFloat(formData.get("weight")?.toString() || "0") || null;
		const dimensions = formData.get("dimensions")?.toString() || "";
		
		// Parsear im√°genes
		const imageUrls = [];
		for (let i = 1; i <= 5; i++) {
			const imageUrl = formData.get(`image_${i}`)?.toString().trim();
			if (imageUrl) {
				imageUrls.push(imageUrl);
			}
		}
		
		// Parsear configuraci√≥n de pagos
		const paymentEnabled = formData.get("payment_enabled") === "on";
		const paymentConfig = {
			enabled: paymentEnabled,
			stripe: {
				enabled: paymentEnabled && formData.get("stripe_enabled") === "on",
				price_id: formData.get("stripe_price_id")?.toString() || ""
			},
			paypal: {
				enabled: paymentEnabled && formData.get("paypal_enabled") === "on",
				item_id: formData.get("paypal_item_id")?.toString() || ""
			},
			mercadopago: {
				enabled: paymentEnabled && formData.get("mercadopago_enabled") === "on",
				preference_id: formData.get("mercadopago_preference_id")?.toString() || ""
			}
		};

		console.log("üìù Datos del formulario:", { 
			title, description, price, stock, category, sku, weight, dimensions, images: imageUrls.length, paymentConfig 
		});

		// Verificaciones
		if (!title || !description || price <= 0 || stock < 0) {
			console.error("‚ùå Campos requeridos faltantes o inv√°lidos");
			error = "Por favor completa todos los campos requeridos con valores v√°lidos";
		} else if (!import.meta.env.PUBLIC_SUPABASE_URL || !import.meta.env.PUBLIC_SUPABASE_ANON_KEY) {
			console.error("‚ùå Variables de entorno no configuradas");
			error = "Variables de entorno de Supabase no configuradas";
		} else {
			console.log("üîç Intentando insertar en Supabase...");
			
			// Crear objeto b√°sico de inserci√≥n
			const insertData: any = {
				title,
				description,
				price,
				stock,
				category
			};

			// Agregar campos opcionales solo si tienen valor
			if (sku) insertData.sku = sku;
			if (weight) insertData.weight = weight;
			if (dimensions) insertData.dimensions = dimensions;
			if (imageUrls.length > 0) insertData.images = imageUrls;
			if (paymentEnabled) insertData.payment_config = paymentConfig;

			const { data, error: insertError } = await supabase
				.from("productos")
				.insert(insertData)
				.select();

			if (insertError) {
				console.error("‚ùå Error de Supabase:", insertError);
				error = `Error de base de datos: ${insertError.message}`;
			} else if (data && data.length > 0) {
				console.log("‚úÖ Producto creado exitosamente:", data[0]);
				success = true;
				// Redireccionar despu√©s de √©xito
				return Astro.redirect("/admin/productos");
			} else {
				console.error("‚ùå No se recibieron datos de la inserci√≥n");
				error = "No se pudo crear el producto";
			}
		}
	} catch (e) {
		console.error("‚ùå Error del servidor:", e);
		error = `Error del servidor: ${e}`;
	}
}
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuevo Producto - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="flex min-h-screen">
      <!-- Sidebar -->
      <aside class="w-64 bg-purple-700 text-white p-6">
        <h1 class="text-3xl font-bold mb-8">TuMarca Admin</h1>
        <nav class="space-y-4">
          <a href="/admin/productos" class="block hover:bg-purple-600 p-2 rounded">üì¶ Productos</a>
          <a href="/admin/nuevo-producto" class="block bg-purple-600 p-2 rounded">‚ûï Nuevo Producto</a>
          <a href="/admin/pedidos" class="block hover:bg-purple-600 p-2 rounded">üßæ Pedidos</a>
          <a href="/" class="block hover:bg-purple-600 p-2 rounded">üîÑ Ir al sitio</a>
        </nav>
      </aside>

      <!-- Contenido principal -->
      <main class="flex-1 p-8">
        <div class="max-w-4xl mx-auto">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-purple-700">Nuevo Producto</h2>
            <a 
              href="/admin/productos" 
              class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-300"
            >
              ‚Üê Volver a Productos
            </a>
          </div>

          {error && (
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
              <strong class="font-bold">‚ùå Error:</strong> {error}
            </div>
          )}

          {success && (
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
              <strong class="font-bold">‚úÖ √âxito:</strong> Producto creado correctamente
            </div>
          )}

          <div class="bg-white rounded-lg shadow-lg p-8">
            <form method="post" class="space-y-8">
              <!-- Informaci√≥n b√°sica -->
              <div class="border-b border-gray-200 pb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">üìã Informaci√≥n B√°sica</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                      Nombre del producto *
                    </label>
                    <input 
                      type="text" 
                      id="title" 
                      name="title" 
                      required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="Nombre del producto"
                    />
                  </div>

                  <div>
                    <label for="sku" class="block text-sm font-medium text-gray-700 mb-2">
                      SKU
                    </label>
                    <input 
                      type="text" 
                      id="sku" 
                      name="sku" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="C√≥digo del producto"
                    />
                  </div>

                  <div>
                    <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                      Precio ($) *
                    </label>
                    <input 
                      type="number" 
                      id="price" 
                      name="price" 
                      step="0.01" 
                      min="0" 
                      required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="0.00"
                    />
                  </div>

                  <div>
                    <label for="stock" class="block text-sm font-medium text-gray-700 mb-2">
                      Stock *
                    </label>
                    <input 
                      type="number" 
                      id="stock" 
                      name="stock" 
                      min="0" 
                      required 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="0"
                    />
                  </div>

                  <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                      Categor√≠a
                    </label>
                    <input 
                      type="text" 
                      id="category" 
                      name="category" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="Ej: Electr√≥nicos, Ropa, etc."
                    />
                  </div>

                  <div>
                    <label for="weight" class="block text-sm font-medium text-gray-700 mb-2">
                      Peso (kg)
                    </label>
                    <input 
                      type="number" 
                      id="weight" 
                      name="weight" 
                      step="0.01" 
                      min="0" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      placeholder="0.00"
                    />
                  </div>
                </div>

                <div class="mt-6">
                  <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Descripci√≥n *
                  </label>
                  <textarea 
                    id="description" 
                    name="description" 
                    rows="4"
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                    placeholder="Describe tu producto..."
                  ></textarea>
                </div>

                <div class="mt-6">
                  <label for="dimensions" class="block text-sm font-medium text-gray-700 mb-2">
                    Dimensiones
                  </label>
                  <input 
                    type="text" 
                    id="dimensions" 
                    name="dimensions" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                    placeholder="Ej: 20cm x 15cm x 5cm"
                  />
                </div>
              </div>

              <!-- Im√°genes -->
              <div class="border-b border-gray-200 pb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">üñºÔ∏è Im√°genes del Producto</h3>
                <p class="text-sm text-gray-600 mb-6">
                  Agrega hasta 5 im√°genes usando URLs o subiendo archivos. La primera imagen ser√° la principal.
                </p>
                
                <div class="space-y-6">
                  {Array.from({ length: 5 }, (_, i) => (
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <h4 class="font-medium text-gray-700 mb-3">
                        Imagen {i + 1}{i === 0 ? ' (Principal)' : ''}
                      </h4>
                      
                      <!-- Tabs para URL o Archivo -->
                      <div class="mb-4">
                        <div class="flex space-x-1 bg-gray-200 p-1 rounded-lg w-fit">
                          <button 
                            type="button"
                            class="tab-btn px-3 py-1 rounded-md text-sm font-medium transition-colors active"
                            onclick={`switchTab(${i + 1}, 'url')`}
                            id={`tab-url-${i + 1}`}
                          >
                            üìù URL
                          </button>
                          <button 
                            type="button"
                            class="tab-btn px-3 py-1 rounded-md text-sm font-medium transition-colors"
                            onclick={`switchTab(${i + 1}, 'file')`}
                            id={`tab-file-${i + 1}`}
                          >
                            üìÅ Archivo
                          </button>
                        </div>
                      </div>

                      <!-- Content URL -->
                      <div id={`content-url-${i + 1}`} class="tab-content">
                        <div class="flex items-center space-x-4">
                          <div class="flex-1">
                            <input 
                              type="url" 
                              name={`image_${i + 1}`} 
                              id={`image_${i + 1}`}
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                              placeholder={`URL de imagen ${i + 1}`}
                              onchange={`previewImage(this, 'preview_${i + 1}')`}
                            />
                          </div>
                          <div 
                            id={`preview_${i + 1}`} 
                            class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400 text-sm overflow-hidden bg-white"
                          >
                            üì∑
                          </div>
                        </div>
                      </div>

                      <!-- Content Archivo -->
                      <div id={`content-file-${i + 1}`} class="tab-content hidden">
                        <div class="flex items-center space-x-4">
                          <div class="flex-1">
                            <div class="relative">
                              <input 
                                type="file" 
                                accept="image/*"
                                class="hidden"
                                id={`file_${i + 1}`}
                                onchange={`handleFileUpload(${i + 1})`}
                              />
                              <label 
                                for={`file_${i + 1}`}
                                class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-500 transition-colors flex items-center justify-center text-gray-600 hover:text-purple-600"
                              >
                                <span id={`file-label-${i + 1}`}>üìÅ Seleccionar imagen...</span>
                              </label>
                              <div id={`upload-progress-${i + 1}`} class="hidden mt-2">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                  <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%" id={`progress-bar-${i + 1}`}></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-1">Subiendo...</p>
                              </div>
                            </div>
                          </div>
                          <div 
                            id={`preview_file_${i + 1}`} 
                            class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center text-gray-400 text-sm overflow-hidden bg-white"
                          >
                            üì∑
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <!-- Configuraci√≥n de pagos -->
              <div class="pb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-6">üí≥ Configuraci√≥n de Pagos</h3>
                
                <div class="mb-6">
                  <label class="flex items-center">
                    <input 
                      type="checkbox" 
                      name="payment_enabled" 
                      class="w-5 h-5 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500"
                      onchange="togglePaymentConfig(this.checked)"
                    />
                    <span class="ml-3 text-sm font-medium text-gray-700">
                      Habilitar pagos online para este producto
                    </span>
                  </label>
                </div>

                <div id="payment-config" class="space-y-6 hidden">
                  <!-- Stripe -->
                  <div class="bg-blue-50 p-6 rounded-lg">
                    <div class="flex items-center mb-4">
                      <input 
                        type="checkbox" 
                        name="stripe_enabled" 
                        id="stripe_enabled"
                        class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                      />
                      <label for="stripe_enabled" class="ml-3 text-sm font-medium text-gray-700">
                        üí≥ Stripe
                      </label>
                    </div>
                    <input 
                      type="text" 
                      name="stripe_price_id" 
                      placeholder="price_1234567890"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                    />
                  </div>

                  <!-- PayPal -->
                  <div class="bg-yellow-50 p-6 rounded-lg">
                    <div class="flex items-center mb-4">
                      <input 
                        type="checkbox" 
                        name="paypal_enabled" 
                        id="paypal_enabled"
                        class="w-5 h-5 text-yellow-600 bg-gray-100 border-gray-300 rounded focus:ring-yellow-500"
                      />
                      <label for="paypal_enabled" class="ml-3 text-sm font-medium text-gray-700">
                        üü° PayPal
                      </label>
                    </div>
                    <input 
                      type="text" 
                      name="paypal_item_id" 
                      placeholder="ITEM123"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 text-sm"
                    />
                  </div>

                  <!-- MercadoPago -->
                  <div class="bg-cyan-50 p-6 rounded-lg">
                    <div class="flex items-center mb-4">
                      <input 
                        type="checkbox" 
                        name="mercadopago_enabled" 
                        id="mercadopago_enabled"
                        class="w-5 h-5 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500"
                      />
                      <label for="mercadopago_enabled" class="ml-3 text-sm font-medium text-gray-700">
                        üîµ MercadoPago
                      </label>
                    </div>
                    <input 
                      type="text" 
                      name="mercadopago_preference_id" 
                      placeholder="123456789-abcd-1234-efgh-567890123456"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 text-sm"
                    />
                  </div>
                </div>
              </div>

              <!-- Botones -->
              <div class="flex justify-between pt-6">
                <a 
                  href="/admin/productos"
                  class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition duration-300"
                >
                  Cancelar
                </a>
                <button 
                  type="submit"
                  class="bg-purple-700 hover:bg-purple-800 text-white px-8 py-3 rounded-lg transition duration-300 font-semibold"
                >
                  üíæ Crear Producto
                </button>
              </div>
            </form>
          </div>
        </div>
      </main>
    </div>

    <script is:inline>
      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        const url = input.value.trim();
        
        if (url) {
          const img = new Image();
          img.onload = function() {
            preview.innerHTML = `<img src="${url}" alt="Preview" class="w-full h-full object-cover" />`;
          };
          img.onerror = function() {
            preview.innerHTML = '‚ùå';
          };
          img.src = url;
        } else {
          preview.innerHTML = 'üì∑';
        }
      }

      function togglePaymentConfig(enabled) {
        const config = document.getElementById('payment-config');
        if (enabled) {
          config.classList.remove('hidden');
        } else {
          config.classList.add('hidden');
        }
      }

      function switchTab(imageIndex, type) {
        // Update tab buttons
        const urlTab = document.getElementById(`tab-url-${imageIndex}`);
        const fileTab = document.getElementById(`tab-file-${imageIndex}`);
        const urlContent = document.getElementById(`content-url-${imageIndex}`);
        const fileContent = document.getElementById(`content-file-${imageIndex}`);

        if (type === 'url') {
          urlTab.classList.add('active', 'bg-white', 'text-purple-700');
          urlTab.classList.remove('text-gray-600');
          fileTab.classList.remove('active', 'bg-white', 'text-purple-700');
          fileTab.classList.add('text-gray-600');
          
          urlContent.classList.remove('hidden');
          fileContent.classList.add('hidden');
          
          // Clear file input and preview
          const fileInput = document.getElementById(`file_${imageIndex}`);
          const filePreview = document.getElementById(`preview_file_${imageIndex}`);
          fileInput.value = '';
          filePreview.innerHTML = 'üì∑';
          
          // Clear the main URL input when switching to file tab
          const urlInput = document.getElementById(`image_${imageIndex}`);
          if (urlInput.dataset.fromFile) {
            urlInput.value = '';
            urlInput.removeAttribute('data-from-file');
          }
        } else {
          fileTab.classList.add('active', 'bg-white', 'text-purple-700');
          fileTab.classList.remove('text-gray-600');
          urlTab.classList.remove('active', 'bg-white', 'text-purple-700');
          urlTab.classList.add('text-gray-600');
          
          fileContent.classList.remove('hidden');
          urlContent.classList.add('hidden');
          
          // Clear URL input and preview
          const urlInput = document.getElementById(`image_${imageIndex}`);
          const urlPreview = document.getElementById(`preview_${imageIndex}`);
          if (!urlInput.dataset.fromFile) {
            urlInput.value = '';
          }
          urlPreview.innerHTML = 'üì∑';
        }
      }

      async function handleFileUpload(imageIndex) {
        const fileInput = document.getElementById(`file_${imageIndex}`);
        const file = fileInput.files[0];
        
        if (!file) return;

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
          alert('Solo se permiten archivos de imagen (JPEG, PNG, WebP, GIF)');
          fileInput.value = '';
          return;
        }

        // Validate file size (5MB)
        const maxSize = 5 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('El archivo es demasiado grande. M√°ximo 5MB permitido.');
          fileInput.value = '';
          return;
        }

        // Update UI
        const label = document.getElementById(`file-label-${imageIndex}`);
        const progress = document.getElementById(`upload-progress-${imageIndex}`);
        const progressBar = document.getElementById(`progress-bar-${imageIndex}`);
        const preview = document.getElementById(`preview_file_${imageIndex}`);

        label.textContent = file.name;
        progress.classList.remove('hidden');
        progressBar.style.width = '20%';

        // Create preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover" />`;
        };
        reader.readAsDataURL(file);

        // Upload file
        try {
          const formData = new FormData();
          formData.append('file', file);

          progressBar.style.width = '50%';

          const response = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });

          progressBar.style.width = '80%';

          const result = await response.json();

          if (result.success) {
            progressBar.style.width = '100%';
            
            // Set the URL in the hidden URL input
            const urlInput = document.getElementById(`image_${imageIndex}`);
            urlInput.value = result.url;
            urlInput.dataset.fromFile = 'true';
            
            setTimeout(() => {
              progress.classList.add('hidden');
              progressBar.style.width = '0%';
            }, 1000);

            console.log('‚úÖ Imagen subida exitosamente:', result.url);
          } else {
            throw new Error(result.error || 'Error desconocido');
          }
        } catch (error) {
          console.error('‚ùå Error subiendo archivo:', error);
          alert(`Error subiendo archivo: ${error.message}`);
          
          // Reset UI
          fileInput.value = '';
          label.textContent = 'üìÅ Seleccionar imagen...';
          progress.classList.add('hidden');
          progressBar.style.width = '0%';
          preview.innerHTML = 'üì∑';
        }
      }

      // Initialize tabs
      document.addEventListener('DOMContentLoaded', function() {
        // Set initial active state for all URL tabs
        for (let i = 1; i <= 5; i++) {
          const urlTab = document.getElementById(`tab-url-${i}`);
          if (urlTab) {
            urlTab.classList.add('active', 'bg-white', 'text-purple-700');
          }
        }

        // Add CSS for active tabs
        const style = document.createElement('style');
        style.textContent = `
          .tab-btn.active {
            background-color: white;
            color: #7c3aed;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
          }
          .tab-btn:not(.active) {
            color: #6b7280;
          }
        `;
        document.head.appendChild(style);
      });
    </script>
  </body>
</html>
