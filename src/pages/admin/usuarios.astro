---
export const prerender = false;

import DashboardLayout from "../../layouts/DashboardLayout.astro";
import { supabase } from '../../lib/supabaseClient';

// El middleware ya verifica que solo super_admin puede acceder

let usuarios: any[] = [];
let error = '';
let success = '';

// Manejar acciones POST (crear, editar, eliminar usuarios)
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const action = formData.get('action') as string;

    if (action === 'create') {
      const email = formData.get('email') as string;
      const name = formData.get('name') as string;
      const role = formData.get('role') as string;
      const password = formData.get('password') as string;

      if (!email || !name || !role || !password) {
        error = 'Todos los campos son obligatorios';
      } else {
        // Verificar que el email no exista
        const { data: existingUser } = await supabase
          .from('admin_users')
          .select('id')
          .eq('email', email)
          .single();

        if (existingUser) {
          error = 'Ya existe un usuario con ese email';
        } else {
          // Crear usuario usando nuestra funci√≥n
          const { createUser } = await import('../../lib/auth');
          await createUser(email, name, password, role);
          success = 'Usuario creado exitosamente';
        }
      }
    } else if (action === 'delete') {
      const userId = formData.get('userId') as string;
      
      if (userId) {
        // No permitir eliminar el propio usuario
        const currentUser = (Astro.locals as any).user;
        if (userId === currentUser?.id) {
          error = 'No puedes eliminar tu propio usuario';
        } else {
          // Eliminar sesiones y auditor√≠a primero
          await supabase.from('admin_sessions').delete().eq('user_id', userId);
          await supabase.from('admin_audit_log').delete().eq('user_id', userId);
          
          // Eliminar usuario
          const { error: deleteError } = await supabase
            .from('admin_users')
            .delete()
            .eq('id', userId);

          if (deleteError) {
            error = 'Error eliminando usuario: ' + deleteError.message;
          } else {
            success = 'Usuario eliminado exitosamente';
          }
        }
      }
    } else if (action === 'toggle_status') {
      const userId = formData.get('userId') as string;
      const newStatus = formData.get('newStatus') as string;
      
      if (userId && newStatus) {
        const currentUser = (Astro.locals as any).user;
        if (userId === currentUser?.id) {
          error = 'No puedes desactivar tu propio usuario';
        } else {
          const { error: updateError } = await supabase
            .from('admin_users')
            .update({ status: newStatus })
            .eq('id', userId);

          if (updateError) {
            error = 'Error actualizando estado: ' + updateError.message;
          } else {
            success = `Usuario ${newStatus === 'active' ? 'activado' : 'desactivado'} exitosamente`;
          }
        }
      }
    } else if (action === 'reset_password') {
      const userId = formData.get('userId') as string;
      const newPassword = formData.get('newPassword') as string;
      
      if (userId && newPassword) {
        const { hashPassword } = await import('../../lib/auth');
        const hashedPassword = await hashPassword(newPassword);
        
        const { error: updateError } = await supabase
          .from('admin_users')
          .update({ 
            password_hash: hashedPassword,
            login_attempts: 0,
            locked_until: null
          })
          .eq('id', userId);

        if (updateError) {
          error = 'Error actualizando contrase√±a: ' + updateError.message;
        } else {
          success = 'Contrase√±a actualizada exitosamente';
        }
      }
    }
  } catch (e) {
    console.error('Error en acci√≥n de usuario:', e);
    error = 'Error procesando la acci√≥n';
  }
}

// Obtener usuarios de la base de datos
try {
  const { data, error: fetchError } = await supabase
    .from('admin_users')
    .select(`
      id, 
      email, 
      name, 
      role, 
      status, 
      last_login, 
      created_at, 
      login_attempts, 
      locked_until
    `)
    .order('created_at', { ascending: false });

  if (fetchError) {
    console.error('Error obteniendo usuarios:', fetchError);
    error = 'Error cargando usuarios';
  } else {
    usuarios = data || [];
  }
} catch (e) {
  console.error('Error conectando a la base de datos:', e);
  error = 'Error de conexi√≥n';
}

// Calcular estad√≠sticas
const stats = {
  totalUsuarios: usuarios.length,
  usuariosActivos: usuarios.filter(u => u.status === 'active').length,
  superAdmins: usuarios.filter(u => u.role === 'super_admin').length,
  managers: usuarios.filter(u => u.role === 'manager').length,
  editors: usuarios.filter(u => u.role === 'editor').length,
  viewers: usuarios.filter(u => u.role === 'viewer').length,
};

// Funci√≥n helper para formatear fechas
function formatDate(dateString: string | null) {
  if (!dateString) return 'Nunca';
  try {
    return new Date(dateString).toLocaleString('es-ES', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch {
    return 'Fecha inv√°lida';
  }
}

// Funci√≥n helper para obtener info del rol
function getRoleInfo(role: string) {
  const roles: Record<string, { color: string; text: string }> = {
    super_admin: { color: 'bg-purple-100 text-purple-800', text: 'Super Admin' },
    manager: { color: 'bg-blue-100 text-blue-800', text: 'Manager' },
    editor: { color: 'bg-green-100 text-green-800', text: 'Editor' },
    viewer: { color: 'bg-gray-100 text-gray-800', text: 'Visualizador' }
  };
  return roles[role] || { color: 'bg-gray-100 text-gray-800', text: role };
}

// Funci√≥n helper para obtener info del estado
function getStatusInfo(status: string) {
  return status === 'active' 
    ? { color: 'bg-green-100 text-green-800', text: '‚úÖ Activo' }
    : { color: 'bg-red-100 text-red-800', text: '‚ùå Inactivo' };
}
---

<DashboardLayout title="Gesti√≥n de Usuarios">
  <div class="space-y-6">
    <!-- Header -->
    <div class="sm:flex sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Gesti√≥n de Usuarios</h1>
        <p class="mt-2 text-sm text-gray-700">
          Administra usuarios, roles y permisos del sistema
        </p>
      </div>
      <div class="mt-4 sm:mt-0">
        <button
          onclick="openCreateModal()"
          class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700"
        >
          + Nuevo Usuario
        </button>
      </div>
    </div>

    <!-- Alertas -->
    {error && (
      <div class="bg-red-50 border-l-4 border-red-400 p-4">
        <p class="text-red-700">{error}</p>
      </div>
    )}
    
    {success && (
      <div class="bg-green-50 border-l-4 border-green-400 p-4">
        <p class="text-green-700">{success}</p>
      </div>
    )}

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">üë•</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Total Usuarios</dt>
                <dd class="text-lg font-medium text-gray-900">{stats.totalUsuarios}</dd>
                <dd class="text-xs text-gray-500">{stats.usuariosActivos} activos</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">üëë</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Super Admins</dt>
                <dd class="text-lg font-medium text-gray-900">{stats.superAdmins}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">üè¢</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Managers</dt>
                <dd class="text-lg font-medium text-gray-900">{stats.managers}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <span class="text-2xl">‚úèÔ∏è</span>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-gray-500 truncate">Editores</dt>
                <dd class="text-lg font-medium text-gray-900">{stats.editors}</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
      <div class="px-4 py-5 sm:p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Usuario
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Rol
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estado
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  √öltimo acceso
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Creado
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {usuarios.map((usuario) => {
                const roleInfo = getRoleInfo(usuario.role);
                const statusInfo = getStatusInfo(usuario.status);
                const isLocked = usuario.locked_until && new Date(usuario.locked_until) > new Date();
                
                return (
                  <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10">
                          <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                            <span class="text-sm font-medium text-indigo-700">
                              {usuario.name.split(' ').map((n: string) => n[0]).join('').toUpperCase()}
                            </span>
                          </div>
                        </div>
                        <div class="ml-4">
                          <div class="text-sm font-medium text-gray-900">{usuario.name}</div>
                          <div class="text-sm text-gray-500">{usuario.email}</div>
                          {isLocked && (
                            <div class="text-xs text-red-500">üîí Bloqueado</div>
                          )}
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${roleInfo.color}`}>
                        {roleInfo.text}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusInfo.color}`}>
                        {statusInfo.text}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {formatDate(usuario.last_login)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {formatDate(usuario.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                      <button
                        onclick={`openPasswordModal('${usuario.id}', '${usuario.name}')`}
                        class="text-indigo-600 hover:text-indigo-900"
                      >
                        üîë Contrase√±a
                      </button>
                      
                      <form method="POST" class="inline">
                        <input type="hidden" name="action" value="toggle_status" />
                        <input type="hidden" name="userId" value={usuario.id} />
                        <input type="hidden" name="newStatus" value={usuario.status === 'active' ? 'inactive' : 'active'} />
                        <button
                          type="submit"
                          class={usuario.status === 'active' ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}
                          onclick="return confirm('¬øEst√°s seguro?')"
                        >
                          {usuario.status === 'active' ? '‚ùå Desactivar' : '‚úÖ Activar'}
                        </button>
                      </form>

                      <form method="POST" class="inline">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="userId" value={usuario.id} />
                        <button
                          type="submit"
                          class="text-red-600 hover:text-red-900"
                          onclick="return confirm('¬øEst√°s seguro de eliminar este usuario? Esta acci√≥n no se puede deshacer.')"
                        >
                          üóëÔ∏è Eliminar
                        </button>
                      </form>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>

          {usuarios.length === 0 && (
            <div class="text-center py-12">
              <span class="text-4xl">üë•</span>
              <h3 class="mt-2 text-sm font-medium text-gray-900">No hay usuarios</h3>
              <p class="mt-1 text-sm text-gray-500">Comienza creando tu primer usuario.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Crear Usuario -->
  <div id="createModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 text-center">Crear Nuevo Usuario</h3>
        <form method="POST" class="mt-4 space-y-4">
          <input type="hidden" name="action" value="create" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              name="email"
              required
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Nombre completo</label>
            <input
              type="text"
              name="name"
              required
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Rol</label>
            <select
              name="role"
              required
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            >
              <option value="">Seleccionar rol</option>
              <option value="super_admin">Super Admin</option>
              <option value="manager">Manager</option>
              <option value="editor">Editor</option>
              <option value="viewer">Visualizador</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
            <input
              type="password"
              name="password"
              required
              minlength="8"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            />
            <p class="mt-1 text-xs text-gray-500">M√≠nimo 8 caracteres</p>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closeCreateModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700"
            >
              Crear Usuario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Contrase√±a -->
  <div id="passwordModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
        <h3 class="text-lg font-medium text-gray-900 text-center">Cambiar Contrase√±a</h3>
        <p id="passwordUserName" class="text-sm text-gray-500 text-center mt-1"></p>
        <form method="POST" class="mt-4 space-y-4">
          <input type="hidden" name="action" value="reset_password" />
          <input type="hidden" id="passwordUserId" name="userId" value="" />
          
          <div>
            <label class="block text-sm font-medium text-gray-700">Nueva contrase√±a</label>
            <input
              type="password"
              name="newPassword"
              required
              minlength="8"
              class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
            />
            <p class="mt-1 text-xs text-gray-500">M√≠nimo 8 caracteres</p>
          </div>

          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closePasswordModal()"
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md hover:bg-indigo-700"
            >
              Cambiar Contrase√±a
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  function openCreateModal() {
    document.getElementById('createModal')?.classList.remove('hidden');
  }

  function closeCreateModal() {
    document.getElementById('createModal')?.classList.add('hidden');
  }

  function openPasswordModal(userId: string, userName: string) {
    const modal = document.getElementById('passwordModal');
    const userNameElement = document.getElementById('passwordUserName');
    const userIdElement = document.getElementById('passwordUserId') as HTMLInputElement;
    
    if (modal && userNameElement && userIdElement) {
      userNameElement.textContent = `Usuario: ${userName}`;
      userIdElement.value = userId;
      modal.classList.remove('hidden');
    }
  }

  function closePasswordModal() {
    document.getElementById('passwordModal')?.classList.add('hidden');
  }

  // Cerrar modales con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeCreateModal();
      closePasswordModal();
    }
  });

  // Cerrar modales haciendo clic fuera
  document.addEventListener('click', (e) => {
    const createModal = document.getElementById('createModal');
    const passwordModal = document.getElementById('passwordModal');
    
    if (e.target === createModal) closeCreateModal();
    if (e.target === passwordModal) closePasswordModal();
  });
</script>
